{"version":3,"sources":["../src/index.js"],"names":["mongoose","require","test","version","Promise","connect","jest","fn","mockImplementation","resolve","createConnection","mockReturnValue","catch","model","bind","on","once","then","ops","mockedReturn","cb","op","modelName","_mongooseOptions","Model","mock","mockingoose","__mocks","err","Error","includes","Array","isArray","map","item","doc","e","validateSync","lean","rawResult","toObject","forEach","Query","prototype","criteria","options","callback","merge","setUpdate","arguments","length","undefined","exec","call","Aggregate","_model","aggregate","insertMany","arr","Object","assign","instance","methodName","constructor","hooks","reject","execPre","ret","execPost","err2","ret2","err3","doMock","proxyTarget","resetAll","toJSON","getMockController","prop","toReturn","o","hasOwnProperty","reset","proxyTraps","get","target","Reflect","apply","thisArg","mockModel","Proxy","module","exports"],"mappings":"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","sourcesContent":["const mongoose = require('mongoose');\n\nif (!/^5/.test(mongoose.version)) {\n  mongoose.Promise = Promise;\n}\n\nmongoose.connect = jest\n  .fn()\n  .mockImplementation(() => Promise.resolve());\n\nmongoose.createConnection = jest.fn().mockReturnValue({\n  catch() {\n    /* no op */\n  },\n  model: mongoose.model.bind(mongoose),\n  on: jest.fn(),\n  once: jest.fn(),\n  then(resolve) {\n    return Promise.resolve(resolve(this));\n  },\n});\n\nconst ops = [\n  'find',\n  'findOne',\n  'count',\n  'countDocuments',\n  'estimatedDocumentCount',\n  'distinct',\n  'findOneAndUpdate',\n  'findOneAndDelete',\n  'findOneAndRemove',\n  'findOneAndReplace',\n  'remove',\n  'update',\n  'updateOne',\n  'updateMany',\n  'deleteOne',\n  'deleteMany',\n  'save',\n  'aggregate',\n];\n\nconst mockedReturn = async function(cb) {\n  const {\n    op,\n    model: { modelName },\n    _mongooseOptions = {},\n  } = this;\n  const Model = mongoose.model(modelName);\n\n  let mock =\n    mockingoose.__mocks[modelName] && mockingoose.__mocks[modelName][op];\n\n  let err = null;\n\n  if (mock instanceof Error) {\n    err = mock;\n  }\n\n  if (typeof mock === 'function') {\n    mock = await mock(this);\n  }\n\n  if (!mock && op === 'save') {\n    mock = this;\n  }\n\n  if (\n    mock &&\n    !(mock instanceof Model) &&\n    ![\n      'remove',\n      'deleteOne',\n      'deleteMany',\n      'update',\n      'updateOne',\n      'updateMany',\n      'count',\n      'countDocuments',\n      'estimatedDocumentCount',\n      'distinct',\n    ].includes(op)\n  ) {\n    mock = Array.isArray(mock)\n      ? mock.map(item => new Model(item))\n      : new Model(mock);\n\n    if(op === 'insertMany') {\n      if(!Array.isArray(mock)) mock = [mock];\n\n      for(const doc of mock) {\n        const e = doc.validateSync();\n        if(e) throw e;\n      }\n    }\n\n    if (_mongooseOptions.lean || _mongooseOptions.rawResult) {\n      mock = Array.isArray(mock)\n        ? mock.map(item => item.toObject())\n        : mock.toObject();\n    }\n  }\n\n  if (cb) {\n    return cb(err, mock);\n  }\n\n  if (err) {\n    throw err;\n  }\n\n  return mock;\n};\n\nops.forEach(op => {\n  mongoose.Query.prototype[op] = jest\n    .fn()\n    .mockImplementation(function(criteria, doc, options, callback) {\n      if (\n        [\n          'find',\n          'findOne',\n          'count',\n          'countDocuments',\n          'remove',\n          'deleteOne',\n          'deleteMany',\n          'update',\n          'updateOne',\n          'updateMany',\n          'findOneAndUpdate',\n          'findOneAndRemove',\n          'findOneAndDelete',\n          'findOneAndReplace',\n        ].includes(op) &&\n        typeof criteria !== 'function'\n      ) {\n        // find and findOne can take conditions as the first paramter\n        // ensure they make it into the Query conditions\n        this.merge(criteria);\n      }\n\n      if (['distinct'].includes(op) && typeof doc !== 'function') {\n        // distinct has the conditions as the second parameter\n        this.merge(doc);\n      }\n\n      if (/update/i.test(op) && typeof doc !== 'function' && doc) {\n        this.setUpdate(doc);\n      }\n\n      switch (arguments.length) {\n        case 4:\n        case 3:\n          if (typeof options === 'function') {\n            callback = options;\n            options = {};\n          }\n          break;\n        case 2:\n          if (typeof doc === 'function') {\n            callback = doc;\n            doc = criteria;\n            criteria = undefined;\n          }\n          options = undefined;\n          break;\n        case 1:\n          if (typeof criteria === 'function') {\n            callback = criteria;\n            criteria = options = doc = undefined;\n          } else {\n            doc = criteria;\n            criteria = options = undefined;\n          }\n      }\n\n      this.op = op;\n\n      if (!callback) {\n        return this;\n      }\n\n      return this.exec.call(this, callback);\n    });\n});\n\nmongoose.Query.prototype.exec = jest.fn().mockImplementation(function(cb) {\n  return mockedReturn.call(this, cb);\n});\n\nmongoose.Aggregate.prototype.exec = jest\n  .fn()\n  .mockImplementation(async function(cb) {\n    const {\n      _model: { modelName },\n    } = this;\n\n    let mock =\n      mockingoose.__mocks[modelName] &&\n      mockingoose.__mocks[modelName].aggregate;\n\n    let err = null;\n\n    if (mock instanceof Error) {\n      err = mock;\n    }\n\n    if (typeof mock === 'function') {\n      mock = await mock(this);\n    }\n\n    if (cb) {\n      return cb(err, mock);\n    }\n\n    if (err) {\n      throw err;\n    }\n\n    return mock;\n  });\n\nmongoose.Model.insertMany = jest\n  .fn()\n  .mockImplementation(function(arr, options, cb) {\n    const op = 'insertMany';\n    const { modelName } = this;\n\n    if (typeof options === 'function') {\n      cb = options;\n      options = null;\n    } else {\n      this._mongooseOptions = options;\n    }\n\n    Object.assign(this, { op, model: { modelName }})\n    return mockedReturn.call(this, cb);\n  })\n\nconst instance = ['remove', 'save'];\n\ninstance.forEach(methodName => {\n  mongoose.Model.prototype[methodName] = jest\n    .fn()\n    .mockImplementation(function(options, cb) {\n      const op = methodName;\n      const { modelName } = this.constructor;\n\n      if (typeof options === 'function') {\n        cb = options;\n      }\n\n      Object.assign(this, { op, model: { modelName } });\n\n      const hooks = this.constructor.hooks;\n\n      return new Promise((resolve, reject) => {\n        hooks.execPre(op, this, [cb], err => {\n          if (err) {\n            reject(err);\n            return;\n          }\n\n          const ret = mockedReturn.call(this, cb);\n\n          if (cb) {\n            hooks.execPost(op, this, [ret], err2 => {\n              if (err2) {\n                reject(err2);\n                return;\n              }\n\n              resolve(ret);\n            });\n          } else {\n            ret\n              .then(ret2 => {\n                hooks.execPost(op, this, [ret2], err3 => {\n                  if (err3) {\n                    reject(err3);\n                    return;\n                  }\n\n                  resolve(ret2);\n                });\n              })\n              .catch(reject);\n          }\n        });\n      });\n    });\n});\n\njest.doMock('mongoose', () => mongoose);\n\n// extend a plain function, we will override it with the Proxy later\nconst proxyTarget = Object.assign(() => void 0, {\n  __mocks: {},\n  resetAll() {\n    this.__mocks = {};\n  },\n  toJSON() {\n    return this.__mocks;\n  },\n});\n\nconst getMockController = prop => {\n  return {\n    toReturn(o, op = 'find') {\n      proxyTarget.__mocks.hasOwnProperty(prop)\n        ? (proxyTarget.__mocks[prop][op] = o)\n        : (proxyTarget.__mocks[prop] = { [op]: o });\n\n      return this;\n    },\n\n    reset(op) {\n      if (op) {\n        delete proxyTarget.__mocks[prop][op];\n      } else {\n        delete proxyTarget.__mocks[prop];\n      }\n\n      return this;\n    },\n\n    toJSON() {\n      return proxyTarget.__mocks[prop] || {};\n    },\n  };\n};\n\nconst proxyTraps = {\n  get(target, prop) {\n    if (target.hasOwnProperty(prop)) {\n      return Reflect.get(target, prop);\n    }\n\n    return getMockController(prop);\n  },\n  apply: (target, thisArg, [prop]) => mockModel(prop),\n};\n\nconst mockingoose = new Proxy(proxyTarget, proxyTraps);\n\n/**\n * Returns a helper with which you can set up mocks for a particular Model\n */\nconst mockModel = (model) => {\n  const modelName = typeof model === 'function' ? model.modelName : model;\n  if (typeof modelName === 'string') {\n    return getMockController(modelName);\n  } else {\n    throw new Error('model must be a string or mongoose.Model');\n  }\n};\n\nmodule.exports = mockingoose;\n"],"file":"index.js"}