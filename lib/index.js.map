{"version":3,"sources":["../src/index.js"],"names":["test","mongoose","version","Promise","connect","jest","fn","mockImplementation","resolve","createConnection","mockReturnValue","on","once","then","catch","model","bind","ops","mockedReturn","cb","op","modelName","_mongooseOptions","Model","mock","mockingoose","__mocks","err","Error","includes","Array","isArray","map","item","lean","toObject","reject","forEach","Query","prototype","criteria","doc","options","callback","arguments","length","undefined","exec","call","Aggregate","_model","aggregate","instance","methodName","constructor","Object","assign","doMock","target","resetAll","toJSON","traps","get","prop","hasOwnProperty","Reflect","toReturn","o","reset","Proxy"],"mappings":"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","file":"index.js","sourcesContent":["import mongoose from 'mongoose';\r\n\r\nif(!/^5/.test(mongoose.version)) mongoose.Promise = Promise;\r\n\r\nmongoose.connect = jest.fn().mockImplementation(() => Promise.resolve());\r\nmongoose.createConnection = jest\r\n  .fn()\r\n  .mockReturnValue({\r\n    on: jest.fn(),\r\n    once: jest.fn(),\r\n    then(resolve) { return Promise.resolve(resolve(this)); },\r\n    catch() {},\r\n    model: mongoose.model.bind(mongoose),\r\n  });\r\n\r\nconst ops = [\r\n  'find',\r\n  'findOne',\r\n  'count',\r\n  'countDocuments',\r\n  'estimatedDocumentCount',\r\n  'distinct',\r\n  'findOneAndUpdate',\r\n  'findOneAndRemove',\r\n  'remove',\r\n  'update',\r\n  'deleteOne',\r\n  'deleteMany',\r\n];\r\n\r\nconst mockedReturn = function (cb) {\r\n  const { op, model: { modelName }, _mongooseOptions = {} } = this;\r\n  const Model = mongoose.model(modelName);\r\n\r\n  let mock = mockingoose.__mocks[modelName] && mockingoose.__mocks[modelName][op];\r\n\r\n  let err = null;\r\n\r\n  if (mock instanceof Error) err = mock;\r\n\r\n  if (!mock && op === 'save') { mock = this;}\r\n\r\n  if (mock && mock instanceof Model === false && (!['update', 'count', 'countDocuments', 'estimatedDocumentCount'].includes(op))) {\r\n    mock = Array.isArray(mock) ? mock.map(item => new Model(item)) : new Model(mock);\r\n\r\n    if (_mongooseOptions.lean) mock = Array.isArray(mock) ? mock.map(item => item.toObject()) : mock.toObject();\r\n  }\r\n\r\n  if (cb) return cb(err, mock);\r\n\r\n  if (err) return Promise.reject(err);\r\n\r\n  return Promise.resolve(mock);\r\n};\r\n\r\nops.forEach(op => {\r\n  mongoose.Query.prototype[op] = jest.fn().mockImplementation(function (criteria, doc, options, callback) {\r\n    switch (arguments.length) {\r\n      case 4:\r\n      case 3:\r\n        if (typeof options === 'function') {\r\n          callback = options;\r\n          options = {};\r\n        }\r\n        break;\r\n      case 2:\r\n        if (typeof doc === 'function') {\r\n          callback = doc;\r\n          doc = criteria;\r\n          criteria = undefined;\r\n        }\r\n        options = undefined;\r\n        break;\r\n      case 1:\r\n        if (typeof criteria === 'function') {\r\n          callback = criteria;\r\n          criteria = options = doc = undefined;\r\n        } else {\r\n          doc = criteria;\r\n          criteria = options = undefined;\r\n        }\r\n    }\r\n\r\n    this.op = op;\r\n\r\n    if (!callback) return this;\r\n\r\n    return this.exec.call(this, callback);\r\n  });\r\n});\r\n\r\nmongoose.Query.prototype.exec = jest.fn().mockImplementation(function cb(cb) {\r\n  return mockedReturn.call(this, cb);\r\n});\r\n\r\nmongoose.Aggregate.prototype.exec = jest.fn().mockImplementation(function cb(cb) {\r\n\tconst { _model: { modelName } } = this;\r\n\r\n\tlet mock = mockingoose.__mocks[modelName] && mockingoose.__mocks[modelName].aggregate;\r\n\r\n\tlet err = null;\r\n\r\n\tif (mock instanceof Error) err = mock;\r\n\r\n\tif (cb) return cb(err, mock);\r\n\r\n\tif (err) return Promise.reject(err);\r\n\r\n\treturn Promise.resolve(mock);\r\n});\r\n\r\nconst instance = [\r\n  'remove',\r\n  'save'\r\n];\r\n\r\ninstance.forEach(methodName => {\r\n  mongoose.Model.prototype[methodName] = jest.fn().mockImplementation(function (options, cb) {\r\n    const op = methodName;\r\n    const { modelName } = this.constructor;\r\n\r\n    if (typeof options === 'function') cb = options;\r\n\r\n    Object.assign(this, { op, model: { modelName } });\r\n\r\n    return mockedReturn.call(this, cb);\r\n  })\r\n});\r\n\r\njest.doMock('mongoose', () => mongoose);\r\n\r\nconst target = {\r\n  __mocks: {},\r\n  resetAll() { this.__mocks = {}; },\r\n  toJSON() { return this.__mocks; },\r\n};\r\n\r\nconst traps = {\r\n  get(target, prop) {\r\n    if (target.hasOwnProperty(prop)) return Reflect.get(target, prop);\r\n\r\n    return {\r\n      toReturn(o, op = 'find') {\r\n        target.__mocks.hasOwnProperty(prop)\r\n          ? target.__mocks[prop][op] = o\r\n          : target.__mocks[prop] = { [op]: o };\r\n\r\n        return this;\r\n      },\r\n\r\n      reset(op) {\r\n        op && delete target.__mocks[prop][op] || delete target.__mocks[prop];\r\n\r\n        return this;\r\n      },\r\n\r\n      toJSON() {\r\n        return target.__mocks[prop] || {};\r\n      },\r\n    };\r\n  },\r\n};\r\n\r\nconst mockingoose = new Proxy(target, traps);\r\n\r\nexport default mockingoose;\r\n"]}